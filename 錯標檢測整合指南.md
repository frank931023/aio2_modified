# AIO2 éŒ¯æ¨™æª¢æ¸¬åŠŸèƒ½æ•´åˆæŒ‡å—

## ğŸ“‹ **å·²å®Œæˆçš„ä¿®æ”¹**

### 1. æ–°å¢éŒ¯æ¨™æª¢æ¸¬æ¨¡çµ„
- **æª”æ¡ˆä½ç½®**: `utils/mislabel_detection.py`
- **åŠŸèƒ½**: æä¾›å®Œæ•´çš„éŒ¯æ¨™æª¢æ¸¬ã€åº§æ¨™è¼¸å‡ºã€çµ±è¨ˆåˆ†æåŠŸèƒ½
- **ä¸»è¦å‡½æ•¸**:
  - `detect_mislabeled_coordinates()`: æª¢æ¸¬éŒ¯æ¨™åº§æ¨™
  - `summarize_epoch_detection()`: åŒ¯ç¸½ epoch ç´šåˆ¥çµ±è¨ˆ
  - `save_detection_visualization()`: ä¿å­˜è¦–è¦ºåŒ–çµæœ
  - `calculate_detection_metrics()`: è¨ˆç®—æª¢æ¸¬æŒ‡æ¨™

### 2. å·²ä¿®æ”¹çš„ä¸»è¦è¨“ç·´æª”æ¡ˆ
- **æª”æ¡ˆ**: `py_scripts/train_unet_png_emaCorrect_singleGPU.py`
- **ä¿®æ”¹å…§å®¹**:
  - æ·»åŠ éŒ¯æ¨™æª¢æ¸¬æ¨¡çµ„å°å…¥
  - æ–°å¢éŒ¯æ¨™æª¢æ¸¬ç›¸é—œå‘½ä»¤è¡Œåƒæ•¸
  - åœ¨æ¨™ç±¤ä¿®æ­£éšæ®µæ•´åˆéŒ¯æ¨™æª¢æ¸¬
  - æ·»åŠ  epoch ç´šåˆ¥æª¢æ¸¬çµæœåŒ¯ç¸½

## ğŸ”§ **éœ€è¦åœ¨å…¶ä»–è¨“ç·´æª”æ¡ˆä¸­é€²è¡Œçš„ä¿®æ”¹**

### å°æ–¼æ‰€æœ‰æœ‰æ¨™ç±¤ä¿®æ­£åŠŸèƒ½çš„æª”æ¡ˆï¼Œéœ€è¦é€²è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

#### A. æ·»åŠ æ¨¡çµ„å°å…¥ (åœ¨ import å€åŸŸ)
```python
import utils.mislabel_detection as mld  # éŒ¯æ¨™æª¢æ¸¬æ¨¡çµ„
```

#### B. æ·»åŠ å‘½ä»¤è¡Œåƒæ•¸ (åœ¨ get_args() å‡½æ•¸ä¸­)
```python
# éŒ¯æ¨™æª¢æ¸¬ç›¸é—œåƒæ•¸
parser.add_argument('--enable_mislabel_detection', action='store_true', 
                    help='æ˜¯å¦å•Ÿç”¨éŒ¯æ¨™æª¢æ¸¬åŠŸèƒ½')
parser.add_argument('--detection_confidence_threshold', type=float, default=0.8,
                    help='éŒ¯æ¨™æª¢æ¸¬çš„ä¿¡å¿ƒåº¦é–¾å€¼')
parser.add_argument('--detection_agreement_threshold', type=float, default=0.7,
                    help='æ•™å¸«å­¸ç”Ÿæ¨¡å‹ä¸€è‡´æ€§é–¾å€¼')
parser.add_argument('--detection_save_interval', type=int, default=5,
                    help='éŒ¯æ¨™æª¢æ¸¬ä¿å­˜é–“éš”ï¼ˆæ¯Nå€‹æ‰¹æ¬¡æª¢æ¸¬ä¸€æ¬¡ï¼‰')
parser.add_argument('--enable_detection_visualization', action='store_true',
                    help='æ˜¯å¦ä¿å­˜éŒ¯æ¨™æª¢æ¸¬è¦–è¦ºåŒ–çµæœ')
```

#### C. åœ¨æ¨™ç±¤ä¿®æ­£éšæ®µæ·»åŠ æª¢æ¸¬ (åœ¨è¨“ç·´è¿´åœˆä¸­)
```python
# åœ¨ correct=True ä¸”æœ‰æ•™å¸«-å­¸ç”Ÿæ¨¡å‹çš„åœ°æ–¹æ·»åŠ 
if args.enable_mislabel_detection and bi % args.detection_save_interval == 0:
    # é€²è¡ŒéŒ¯æ¨™æª¢æ¸¬
    with torch.no_grad():
        # ç²å–å­¸ç”Ÿæ¨¡å‹é æ¸¬
        pred_logits_student = net(images).squeeze(axis=1)
        
        # é€²è¡ŒéŒ¯æ¨™æª¢æ¸¬
        detection_results = mld.detect_mislabeled_coordinates(
            teacher_pred=pred_logits_it,  # æ•™å¸«æ¨¡å‹é æ¸¬
            student_pred=pred_logits_student,  # å­¸ç”Ÿæ¨¡å‹é æ¸¬
            ns_masks=ns_masks,  # é›œè¨Šæ¨™ç±¤
            gt_masks=gt_masks,  # çœŸå¯¦æ¨™ç±¤
            image_indices=None,
            epoch=epoch,
            batch_idx=bi,
            save_dir=pdir,
            confidence_threshold=args.detection_confidence_threshold,
            agreement_threshold=args.detection_agreement_threshold
        )
        
        # è¨ˆç®—å’Œè¨˜éŒ„æª¢æ¸¬æŒ‡æ¨™
        batch_metrics = mld.calculate_detection_metrics(detection_results)
        
        if args.batch_to_wandb and detection_results:
            wandb.log({
                'mislabel_detection/batch_precision': batch_metrics['batch_precision'],
                'mislabel_detection/batch_recall': batch_metrics['batch_recall'],
                'mislabel_detection/batch_f1': batch_metrics['batch_f1'],
                'mislabel_detection/batch_tp': batch_metrics['batch_tp'],
                'mislabel_detection/batch_fp': batch_metrics['batch_fp'],
                'mislabel_detection/batch_fn': batch_metrics['batch_fn'],
                'step': steps
            })
        
        # è¼¸å‡ºæª¢æ¸¬çµ±è¨ˆ
        if detection_results:
            print(f"  éŒ¯æ¨™æª¢æ¸¬ - Epoch {epoch+1}, Batch {bi}: "
                  f"Precision={batch_metrics['batch_precision']:.3f}, "
                  f"Recall={batch_metrics['batch_recall']:.3f}, "
                  f"F1={batch_metrics['batch_f1']:.3f}")
```

#### D. æ·»åŠ  epoch ç´šåˆ¥åŒ¯ç¸½ (åœ¨ epoch çµæŸæ™‚)
```python
# åœ¨ correct=True çš„åˆ†æ”¯ä¸­æ·»åŠ 
if args.enable_mislabel_detection:
    detection_summary = mld.summarize_epoch_detection(
        detection_dir=os.path.join(pdir, 'mislabel_detection'),
        epoch=epoch,
        wandb_log=True
    )
    
    if detection_summary:
        print(f"  Epoch {epoch+1} éŒ¯æ¨™æª¢æ¸¬åŒ¯ç¸½:")
        print(f"    ç²¾ç¢ºåº¦: {detection_summary['precision']:.4f}")
        print(f"    å¬å›ç‡: {detection_summary['recall']:.4f}") 
        print(f"    F1åˆ†æ•¸: {detection_summary['f1_score']:.4f}")
        print(f"    TP/FP/FN: {detection_summary['total_tp']}/{detection_summary['total_fp']}/{detection_summary['total_fn']}")
```

## ğŸ“ **éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®**

### æœ‰æ¨™ç±¤ä¿®æ­£åŠŸèƒ½çš„æª”æ¡ˆï¼ˆé«˜å„ªå…ˆç´šï¼‰:
1. âœ… `py_scripts/train_unet_png_emaCorrect_singleGPU.py` - å·²å®Œæˆ
2. ğŸ”„ `py_scripts/train_unet_png_pixelCorrect_singleGPU.py` - éƒ¨åˆ†å®Œæˆ
3. ğŸ”„ `py_scripts/train_unet_h5_smp_emaCorrect_singleGPU.py`
4. ğŸ”„ `py_scripts/train_unet_h5_smp_pixelCorrect_singleGPU.py`

### æœ‰ EMA æ•™å¸«-å­¸ç”Ÿæ¶æ§‹çš„æª”æ¡ˆï¼ˆä¸­å„ªå…ˆç´šï¼‰:
5. ğŸ”„ `py_scripts/train_unet_png_emaConsistReg_singleGPU.py`
6. ğŸ”„ `py_scripts/train_unet_h5_smp_emaConsistReg_singleGPU.py`
7. ğŸ”„ `py_scripts/train_unet_png_bootstrap_singleGPU.py`
8. ğŸ”„ `py_scripts/train_unet_h5_smp_bootstrap_singleGPU.py`

### åŸºç·šæª”æ¡ˆï¼ˆä½å„ªå…ˆç´šï¼‰:
9. ğŸ”„ `py_scripts/train_unet_png_baseline_singleGPU.py`
10. ğŸ”„ `py_scripts/train_unet_h5_smp_baseline_singleGPU.py`

## ğŸš€ **ä½¿ç”¨æ–¹æ³•**

### å•Ÿç”¨éŒ¯æ¨™æª¢æ¸¬çš„å‘½ä»¤ç¯„ä¾‹:
```bash
python train_unet_png_emaCorrect_singleGPU.py \
    --data_path "è³‡æ–™è·¯å¾‘" \
    --epochs 100 \
    --batch_size 25 \
    --enable_mislabel_detection \
    --detection_confidence_threshold 0.8 \
    --detection_agreement_threshold 0.7 \
    --detection_save_interval 5 \
    --enable_detection_visualization
```

## ğŸ“Š **è¼¸å‡ºçµæœ**

### 1. æª”æ¡ˆè¼¸å‡º:
- `Results/æ¨¡å‹åç¨±/mislabel_detection/detection_epoch_X_batch_Y.json`: æ‰¹æ¬¡ç´šæª¢æ¸¬çµæœ
- `Results/æ¨¡å‹åç¨±/mislabel_detection/epoch_X_summary.json`: epoch ç´šåŒ¯ç¸½çµæœ

### 2. çµ‚ç«¯è¼¸å‡º:
- æ‰¹æ¬¡ç´šæª¢æ¸¬çµ±è¨ˆï¼šPrecision/Recall/F1
- Epoch ç´šåŒ¯ç¸½çµ±è¨ˆï¼šç¸½é«”æª¢æ¸¬æ€§èƒ½

### 3. WandB è¨˜éŒ„:
- `mislabel_detection/batch_*`: æ‰¹æ¬¡ç´šæŒ‡æ¨™
- `mislabel_detection/epoch_*`: epoch ç´šæŒ‡æ¨™

## ğŸ“ **JSON çµæœæ ¼å¼ç¯„ä¾‹**

### æ‰¹æ¬¡æª¢æ¸¬çµæœ:
```json
{
  "epoch_5_batch_10_img_0": {
    "epoch": 5,
    "batch_idx": 10,
    "suspicious_coords": [[120, 150], [121, 150]],
    "suspicious_count": 2,
    "tp_coords": [[120, 150]],
    "fp_coords": [[121, 150]], 
    "fn_coords": [[130, 160]],
    "tp_count": 1,
    "fp_count": 1,
    "fn_count": 1,
    "precision": 0.5,
    "recall": 0.5
  }
}
```

### Epoch åŒ¯ç¸½çµæœ:
```json
{
  "epoch": 5,
  "total_tp": 45,
  "total_fp": 23,
  "total_fn": 12,
  "precision": 0.662,
  "recall": 0.789,
  "f1_score": 0.720,
  "num_images_detected": 150
}
```

## âš ï¸ **æ³¨æ„äº‹é …**

1. **é©ç”¨æ¢ä»¶**: éŒ¯æ¨™æª¢æ¸¬åŠŸèƒ½éœ€è¦æ•™å¸«-å­¸ç”Ÿæ¨¡å‹æ¶æ§‹æ‰èƒ½æœ‰æ•ˆå·¥ä½œ
2. **æ€§èƒ½å½±éŸ¿**: å•Ÿç”¨æª¢æ¸¬æœƒç¨å¾®å¢åŠ è¨ˆç®—æ™‚é–“ï¼Œå»ºè­°é©ç•¶è¨­ç½® `detection_save_interval`
3. **å­˜å„²ç©ºé–“**: æª¢æ¸¬çµæœæœƒç”¢ç”Ÿ JSON æª”æ¡ˆï¼Œé•·æœŸè¨“ç·´éœ€æ³¨æ„ç£ç¢Ÿç©ºé–“
4. **çœŸå¯¦æ¨™ç±¤**: æœ‰çœŸå¯¦æ¨™ç±¤æ™‚æ‰èƒ½è¨ˆç®— TP/FP/FNï¼Œå¦å‰‡åªèƒ½æª¢æ¸¬å¯ç–‘å€åŸŸ

## ğŸ¯ **ç ”ç©¶ç”¨é€”**

æ­¤åŠŸèƒ½ç‰¹åˆ¥é©åˆç”¨æ–¼ï¼š
1. **è©•ä¼°éŒ¯æ¨™æª¢æ¸¬æ–¹æ³•**: é‡åŒ–æ¯”è¼ƒä¸åŒæ–¹æ³•çš„æª¢æ¸¬èƒ½åŠ›
2. **è«–æ–‡å¯¦é©—**: æä¾› TP/FP/FN çµ±è¨ˆç”¨æ–¼è«–æ–‡æ’°å¯«
3. **æ¨™ç±¤å“è³ªåˆ†æ**: åˆ†æè³‡æ–™é›†ä¸­çš„æ¨™ç±¤éŒ¯èª¤æ¨¡å¼
4. **æ¨¡å‹å¯è§£é‡‹æ€§**: äº†è§£æ¨¡å‹å¦‚ä½•è­˜åˆ¥éŒ¯èª¤æ¨™ç±¤